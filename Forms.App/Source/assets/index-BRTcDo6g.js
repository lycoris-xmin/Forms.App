import{_ as be}from"./table-header-operation.vue_vue_type_script_setup_true_lang-C7seoTxq.js";import{_ as se,S as ie,a as we,b as ye,U as ke,T as Ie,u as xe,c as De,d as Ce,e as Ae}from"./table-search-filter-DgS7ifzw.js";import{m as E,d as K,D as N,E as Q,c as F,o as A,w as a,f as e,e as s,h as c,a7 as te,B as j,s as de,a as Re,r as q,F as re,g as k,b as W,z as M,t as z,a8 as Y,a9 as ae}from"./index-CZVtSjPQ.js";import{L as Te}from"./index-Y4HE4_-c.js";import{c as J,S as he,a as ne,F as Se}from"./enum-map-command-BRiq8gWm.js";import{u as $e,A as Fe}from"./app.permissions-B_pV7apU.js";import{c as le,d as oe}from"./helper-sl_fDmSa.js";import{u as ue,F as me,_ as ce,I as Ue,a as Be,d as Oe}from"./form-ZxLsforZ.js";import{_ as pe}from"./index-DOEbmRvB.js";import{R as Le}from"./dayjs-AyO5q5yK.js";import{_ as X}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{d as Pe}from"./debounce-BsWDECm-.js";import{S as fe}from"./index-BWb-9rJv.js";import{_ as ve}from"./index-BVBn8Dpq.js";import{b as ze}from"./enums-XBoEbamp.js";import{L as He}from"./index-C3lI4CWL.js";import{C as _e}from"./index-ClUX1lZP.js";import{T as H}from"./index-DMMLrYUn.js";import{D as Me,a as je}from"./index-CmnjSmWG.js";import"./index-CQCXu6T9.js";import"./EyeOutlined-B3DWie8W.js";import"./index-Ds_LW8Zf.js";import"./LeftOutlined-Cj56myxb.js";import"./responsiveObserve-CdtC9r70.js";import"./isSymbol-DgABtkrl.js";function Ee(i){const{pageIndex:x,pageSize:l}=i,_={pageIndex:x,pageSize:l};return i.id&&(_.id=i.id),i.deviceId&&(_.deviceId=i.deviceId),i.taskId&&(_.taskId=i.taskId),typeof i.command=="number"&&(_.command=i.command),typeof i.status=="number"&&(_.status=i.status),i.beginTime&&(_.beginTime=i.beginTime),i.endTime&&(_.endTime=i.endTime),E({url:"/api/device/command/list",params:{..._}})}function Ve(i){return E({url:`/api/device/command/${i}`})}function Ne({deviceId:i,command:x,data:l}){return E({url:"/api/device/command/debugger",method:"post",data:{deviceId:i,command:x,data:l}})}function Ke(i){return E({url:`/api/device/command/log/upload/${i}`})}function Ge(i){return E({url:`/api/device/command/scriptLog/${i}`})}const Ye={class:"flex-1"},qe={class:"w-full flex-y-center justify-end gap-12px"},We=K({name:"DeviceCommandListSearch",__name:"search-filter",props:N({command:{default:()=>[]},status:{default:()=>[]}},{model:{required:!0},modelModifiers:{}}),emits:N(["reset","search"],["update:model"]),setup(i,{emit:x}){const{formRef:l,validate:_,resetFields:h}=ue(),r=Q(i,"model"),D=i,S=x;async function b(){await h(),S("reset")}async function n(){await _(),S("search")}function g(T,u){r.value.beginTime=u[0],r.value.endTime=u[1]}function L(){}return(T,u)=>{const C=Ue,w=ce,I=pe,U=ie,p=Le,o=we,y=j,f=ye,t=se,v=me;return A(),F(Ie,null,{extra:a(()=>[s("span",{class:"collapse",onClick:L},[e(c(ke))])]),default:a(()=>[e(v,{ref_key:"formRef",ref:l,name:"filer",model:r.value,"label-col":{span:5,md:7}},{default:a(()=>[e(t,{gutter:[16,16],wrap:""},{default:a(()=>[e(I,{span:24,md:12,lg:6},{default:a(()=>[e(w,{label:"指令编号",name:"id",class:"m-0"},{default:a(()=>[e(C,{value:r.value.id,"onUpdate:value":u[0]||(u[0]=d=>r.value.id=d),autocomplete:"off",placeholder:"精准查询"},null,8,["value"])]),_:1})]),_:1}),e(I,{span:24,md:12,lg:6},{default:a(()=>[e(w,{label:"设备编号",name:"deviceId",class:"m-0"},{default:a(()=>[e(C,{value:r.value.deviceId,"onUpdate:value":u[1]||(u[1]=d=>r.value.deviceId=d),autocomplete:"off",placeholder:"精准查询"},null,8,["value"])]),_:1})]),_:1}),e(I,{span:24,md:12,lg:6},{default:a(()=>[e(w,{label:"任务编号",name:"taskId",class:"m-0"},{default:a(()=>[e(C,{value:r.value.taskId,"onUpdate:value":u[2]||(u[2]=d=>r.value.taskId=d),autocomplete:"off",placeholder:"精准查询"},null,8,["value"])]),_:1})]),_:1}),e(I,{span:24,md:12,lg:6},{default:a(()=>[e(w,{label:"执行指令",name:"command"},{default:a(()=>[e(U,{value:r.value.command,"onUpdate:value":u[3]||(u[3]=d=>r.value.command=d),placeholder:"- 全部 -",options:D.command,"allow-clear":""},null,8,["value","options"])]),_:1})]),_:1}),e(I,{span:24,md:12,lg:6},{default:a(()=>[e(w,{label:"执行状态",name:"status"},{default:a(()=>[e(U,{value:r.value.status,"onUpdate:value":u[4]||(u[4]=d=>r.value.status=d),placeholder:"- 全部 -",options:D.status,"allow-clear":""},null,8,["value","options"])]),_:1})]),_:1}),e(I,{span:24,md:12,lg:6},{default:a(()=>[e(w,{label:"执行时间",name:"createTimeRange",class:"m-0"},{default:a(()=>[e(p,{value:r.value.createTimeRange,"onUpdate:value":u[5]||(u[5]=d=>r.value.createTimeRange=d),"show-time":{defaultValue:[c(te)("00:00:00","HH:mm:ss"),c(te)("23:59:59","HH:mm:ss")]},format:"YYYY-MM-DD HH:mm:ss",placeholder:["开始时间","结束时间"],onChange:g},null,8,["value","show-time"])]),_:1})]),_:1}),s("div",Ye,[e(w,{class:"m-0"},{default:a(()=>[s("div",qe,[e(y,{onClick:b},{icon:a(()=>[e(o,{class:"align-sub text-icon"})]),default:a(()=>[u[6]||(u[6]=s("span",{class:"ml-8px"},"重置",-1))]),_:1}),e(y,{type:"primary",ghost:"",onClick:n},{icon:a(()=>[e(f,{class:"align-sub text-icon"})]),default:a(()=>[u[7]||(u[7]=s("span",{class:"ml-8px"},"搜索",-1))]),_:1})])]),_:1})])]),_:1})]),_:1},8,["model"])]),_:1})}}}),Je=X(We,[["__scopeId","data-v-c1f431d4"]]),Qe={class:"body"},Xe={class:"v-center flex gap-5px"},Ze=K({name:"AutoJsScriptOperateDrawer",__name:"create-drawer",props:{visible:{type:Boolean,default:!1},visibleModifiers:{}},emits:N(["submitted"],["update:visible"]),setup(i,{emit:x}){const{formRef:l,validate:_,resetFields:h}=ue(),r=Q(i,"visible"),D=de({submit:!1}),S=Re(()=>J.filter(p=>p.value!==0)),b=x,n=q(T()),{defaultRequiredRule:g}=Be(),L={deviceId:g,command:g,data:[{validator:(p,o)=>{if(o.trim()!=="")try{const y=JSON.parse(o);if(!y||!Object.keys(y).length)return Promise.reject(new Error("任务参数格式错误，不是json格式"))}catch{return Promise.reject(new Error("任务参数格式错误，不是json格式"))}return Promise.resolve()},trigger:"change"}]};re(r,()=>{r.value&&(u(),h(),w())});function T(){return{deviceId:"",command:1e3,data:"",laseSearchFilter:"",deviceIdOptions:[]}}function u(){n.value=T()}const C=Pe(async p=>{n.value.laseSearchFilter=p;const{data:o,error:y}=await ze(p);!y&&o&&o.code===0&&o.data&&o.data.list&&o.data.list.length&&(n.value.deviceIdOptions=o.data.list.map(f=>({value:f.value,label:f.text})),n.value.deviceIdOptions.length===1&&(n.value.deviceId=n.value.deviceIdOptions[0].value))});function w(){C(n.value.laseSearchFilter)}function I(){r.value=!1}async function U(){var p;await _(),D.submit=!0;try{const{data:o,error:y}=await Ne({...n.value});!y&&o&&o.code===0&&((p=window.$message)==null||p.success("保存成功"),I(),b("submitted"))}finally{D.submit=!1}}return(p,o)=>{const y=ie,f=ce,t=j,v=Oe,d=me,P=fe,G=ve;return A(),F(G,{open:r.value,"onUpdate:open":o[3]||(o[3]=$=>r.value=$),title:"调试指令",width:500},{footer:a(()=>[e(P,{size:16},{default:a(()=>[e(t,{onClick:I},{default:a(()=>o[6]||(o[6]=[k("取消")])),_:1}),e(t,{type:"primary",loading:D.submit,onClick:U},{default:a(()=>o[7]||(o[7]=[k("保存")])),_:1},8,["loading"])]),_:1})]),default:a(()=>[s("div",Qe,[e(d,{ref_key:"formRef",ref:l,name:"operate",layout:"vertical",model:n.value,rules:L},{default:a(()=>[e(f,{label:"执行指令",name:"command"},{default:a(()=>[e(y,{value:n.value.command,"onUpdate:value":o[0]||(o[0]=$=>n.value.command=$),placeholder:"- 全部 -",options:S.value,"allow-clear":""},null,8,["value","options"])]),_:1}),e(f,{label:"选择设备",name:"command"},{default:a(()=>[s("div",Xe,[e(y,{value:n.value.deviceId,"onUpdate:value":o[1]||(o[1]=$=>n.value.deviceId=$),placeholder:"- 请选择 -","show-search":"","default-active-first-option":!1,"show-arrow":!1,"filter-option":!1,options:n.value.deviceIdOptions,onSearch:c(C)},{notFoundContent:a(()=>o[4]||(o[4]=[s("p",null,"没有找到可用设备",-1)])),_:1},8,["value","options","onSearch"]),e(t,{onClick:w},{default:a(()=>o[5]||(o[5]=[k("刷新")])),_:1})])]),_:1}),e(f,{label:"任务参数",name:"data"},{default:a(()=>[e(v,{value:n.value.data,"onUpdate:value":o[2]||(o[2]=$=>n.value.data=$),placeholder:"请输入任务参数（json格式），若任务没有参数可不填","auto-size":{minRows:6}},null,8,["value"])]),_:1})]),_:1},8,["model"])])]),_:1},8,["open"])}}}),et={class:"info-item"},tt={class:"info-value"},at={class:"info-item"},nt={class:"command-content"},lt={class:"info-item"},ot={class:"info-item"},st={class:"info-value"},it={key:0,class:"error-info"},dt={class:"error-content"},rt={key:1,class:"right-info"},ut=K({name:"DeviceOperationDetailDrawer",__name:"device-scriptlog",props:N({commandId:{}},{visible:{type:Boolean,default:!1},visibleModifiers:{}}),emits:["update:visible"],setup(i){const x=Q(i,"visible"),l=i,_=q(!0),h=q([]);re(()=>x.value,async b=>{b?await r():h.value=[]});async function r(){_.value=!0;try{const{data:b,error:n}=await Ge(l.commandId);!n&&b&&b.code===0&&(h.value=b.data.list.map(g=>({...g,statusLabel:D(g.status),statusCode:g.status})))}finally{_.value=!1}}function D(b){const n=he.find(g=>g.value===b);return n?n.label:"未知状态"}function S(){x.value=!1}return(b,n)=>{const g=pe,L=H,T=se,u=_e,C=He,w=j,I=fe,U=ve;return A(),F(U,{open:l.visible,title:"设备运行详情",width:"50%"},{footer:a(()=>[e(I,{size:16},{default:a(()=>[e(w,{onClick:S},{default:a(()=>n[6]||(n[6]=[k("关闭")])),_:1})]),_:1})]),default:a(()=>[e(C,{"item-layout":"vertical","data-source":h.value,loading:_.value,class:"custom-list"},{renderItem:a(({item:p})=>[e(u,{class:"list-card"},{default:a(()=>[e(T,{gutter:16},{default:a(()=>[e(g,{span:12},{default:a(()=>[s("div",et,[n[0]||(n[0]=s("span",{class:"info-label"},"任务ID：",-1)),s("span",tt,z(p.taskId||"无"),1)]),s("div",at,[n[1]||(n[1]=s("span",{class:"info-label"},"指令内容：",-1)),s("pre",nt,z(p.commandContent),1)])]),_:2},1024),e(g,{span:12},{default:a(()=>[s("div",lt,[n[2]||(n[2]=s("span",{class:"info-label"},"运行状态：",-1)),e(L,{color:p.statusCode>=2&&p.statusCode<=5?"error":"processing"},{default:a(()=>[k(z(p.statusLabel),1)]),_:2},1032,["color"])]),s("div",ot,[n[3]||(n[3]=s("span",{class:"info-label"},"开始时间：",-1)),s("span",st,z(p.runTime),1)])]),_:2},1024)]),_:2},1024),p.statusCode>=2&&p.statusCode<=5?(A(),W("div",it,[n[4]||(n[4]=s("span",{class:"error-label"},"错误信息：",-1)),s("div",dt,z(p.errorMessage||"无"),1)])):[0,1,6].includes(p.statusCode)?(A(),W("div",rt,n[5]||(n[5]=[s("span",{class:"right-label"},"执行状态：",-1),s("div",{class:"right-content"},"无错误，执行成功",-1)]))):M("",!0)]),_:2},1024)]),_:1},8,["data-source","loading"])]),_:1},8,["open"])}}}),mt=X(ut,[["__scopeId","data-v-d06afbd0"]]),ct={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"},pt={class:"expande-row"},ft={class:"content"},vt={class:"content"},_t={class:"v-center flex gap-10px"},gt=K({name:"maintain_command",__name:"index",setup(i){const x=$e(),l=de({rowDetail:{},expandedRowKeys:[],detailVisible:!1,id:""}),{tableWrapperRef:_,scrollConfig:h}=xe(),{columns:r,columnChecks:D,data:S,getData:b,getDataByPage:n,loading:g,mobilePagination:L,searchParams:T,resetSearchParams:u}=De({apiFn:f=>(l.rowDetail={},l.expandedRowKeys=[],Ee(f)),apiParams:{pageIndex:1,pageSize:10},columns:I}),{drawerVisible:C,handleAdd:w}=Ce(S,b);function I(){return[{key:"id",dataIndex:"id",title:"指令编号",align:"center",width:180},{key:"deviceId",dataIndex:"deviceId",title:"执行设备",align:"center",width:280,ellipsis:!0,customRender:({record:t})=>!t.deviceId||t.deviceId==="0"?e(H,{color:"error"},{default:()=>[k("设备已删除")]}):e("p",null,[t.deviceName,k(" ("),t.deviceId,k(")")])},{key:"taskId",dataIndex:"taskId",title:"所属任务",align:"center",width:220,customRender:({record:t})=>t.taskId&&t.taskId!=="0"?e("p",null,[t.taskId]):e(H,{color:"default"},{default:()=>[k("-")]})},{key:"command",dataIndex:"command",title:"执行指令",align:"center",width:150,customRender:({record:t})=>{const v=J.find(d=>d.value===t.command);return v?e(H,{color:v.color},{default:()=>[v.label]}):"-"}},{key:"status",dataIndex:"status",title:"状态",align:"center",width:100,customRender:({record:t})=>{const v=ne.filter(d=>d.value===t.status)[0];return t.status===31?e(ae,{placement:"top",title:e("span",null,[t.errorRemark||"未知异常"])},{default:()=>[e(H,{color:v.color},{default:()=>[v.label]})]}):e(H,{color:v.color},{default:()=>[v.label]})}},{key:"ipAddress",dataIndex:"ipAddress",title:"设备IP",align:"center",ellipsis:!0,width:180,customRender:({record:t})=>t.ipAddress&&t.ip?`${t.ip}(${t.ipAddress})`:t.ip?`${t.ip}(未知)`:"未知"},{key:"createTime",dataIndex:"createTime",title:"添加时间",align:"center",width:200},{key:"assginTime",dataIndex:"assginTime",title:"执行时间",align:"center",width:200},{key:"completeTime",dataIndex:"completeTime",title:"完成时间",align:"center",width:200},{key:"operate",title:"操作",align:"center",fixed:"right",width:120,customRender:({record:t})=>e("div",{class:"flex-center gap-4px"},[e(U,{record:t},null)])}]}function U({record:f}){return e(ae,{placement:"top",title:"详情"},{default:()=>[e(j,{type:"link",size:"small",onClick:()=>p(f.id)},{default:()=>[e(Se,null,null)]})]})}function p(f){l.id=f,l.detailVisible=!0}async function o(f,t){if(f&&!(l.rowDetail[t.id]&&Object.keys(l.rowDetail[t.id]).length)){l.rowDetail[t.id]={},l.rowDetail[t.id].loading=!0;try{const{data:v,error:d}=await Ve(t.id);!d&&v&&v.code===0&&v.data&&Object.assign(l.rowDetail[t.id],v.data)}finally{l.rowDetail[t.id].loading=!1}}}async function y(f){var t;(t=window.$modal)==null||t.confirm({title:"上传提示",cancelText:"取消",okText:"确定",content:"日志上传指令需要等待设备空闲，请稍后再来查看",async onOk(){var v;f.loading=!0;try{const{data:d,error:P}=await Ke(f.id);!P&&d&&d.code===0&&((v=window.$message)==null||v.success("指令下发成功，请耐心等待！"),b())}finally{f.loading=!1}}})}return(f,t)=>{const v=be,d=j,P=je,G=Me,$=Ae,ge=_e;return A(),W("div",ct,[e(Je,{model:c(T),"onUpdate:model":t[0]||(t[0]=m=>Y(T)?T.value=m:null),command:c(J),status:c(ne),onReset:c(u),onSearch:t[1]||(t[1]=m=>c(n)(1))},null,8,["model","command","status","onReset"]),e(ge,{title:"指令列表",bordered:!1,"body-style":{flex:1,overflow:"hidden"},class:"flex-col-stretch sm:flex-1-hidden card-wrapper"},{extra:a(()=>[e(v,{columns:c(D),"onUpdate:columns":t[2]||(t[2]=m=>Y(D)?D.value=m:null),loading:c(g),"add-btn":c(x).hasOne(c(Fe).Maintain.Commnad.CREATE),"delete-btn":!1,onAdd:c(w)},null,8,["columns","loading","add-btn","onAdd"])]),default:a(()=>[e($,{ref_key:"tableWrapperRef",ref:_,"expanded-row-keys":l.expandedRowKeys,"onUpdate:expandedRowKeys":t[3]||(t[3]=m=>l.expandedRowKeys=m),columns:c(r),"data-source":c(S),size:"small",scroll:c(h),loading:c(g),"row-key":"id",pagination:c(L),class:"h-full",onExpand:o},{expandedRowRender:a(({record:m})=>{var Z,ee;return[s("div",pt,[e(G,{bordered:"",column:3},{default:a(()=>[e(P,{label:"执行内容",span:3},{default:a(()=>{var B,O;return[s("div",ft,[s("div",null,[s("p",null,z(((B=l.rowDetail[m.id])==null?void 0:B.data)||""),1)]),s("div",null,[(O=l.rowDetail[m.id])!=null&&O.data?(A(),F(d,{key:0,size:"small",type:"primary",ghost:"",onClick:V=>{var R;return c(le)(((R=l.rowDetail[m.id])==null?void 0:R.data)||"-")}},{default:a(()=>t[8]||(t[8]=[k(" 复制 ")])),_:2},1032,["onClick"])):M("",!0)])])]}),_:2},1024),e(P,{label:"执行回执",span:3},{default:a(()=>{var B,O;return[s("div",vt,[s("div",null,[s("p",null,z(((B=l.rowDetail[m.id])==null?void 0:B.result)||"-"),1)]),s("div",null,[(O=l.rowDetail[m.id])!=null&&O.result?(A(),F(d,{key:0,size:"small",type:"primary",ghost:"",onClick:V=>{var R;return c(le)(((R=l.rowDetail[m.id])==null?void 0:R.result)||"")}},{default:a(()=>t[9]||(t[9]=[k(" 复制 ")])),_:2},1032,["onClick"])):M("",!0)])])]}),_:2},1024),e(P,{label:"日志文件",span:3},{default:a(()=>{var B,O;return[s("div",_t,[(B=l.rowDetail[m.id])!=null&&B.logFile?(A(),F(d,{key:0,size:"small",type:"primary",ghost:"",onClick:V=>{var R;return c(oe)((R=l.rowDetail[m.id])==null?void 0:R.logFile)}},{default:a(()=>t[10]||(t[10]=[k(" 下载日志 ")])),_:2},1032,["onClick"])):(A(),F(d,{key:1,size:"small",danger:"",ghost:"",loading:m.loading,onClick:V=>y(m)},{default:a(()=>t[11]||(t[11]=[k(" 设备端上传日志 ")])),_:2},1032,["loading","onClick"])),(O=l.rowDetail[m.id])!=null&&O.screenshot?(A(),F(d,{key:2,size:"small",type:"primary",ghost:"",onClick:V=>{var R;return c(oe)((R=l.rowDetail[m.id])==null?void 0:R.screenshot)}},{default:a(()=>t[12]||(t[12]=[k(" 下载截屏 ")])),_:2},1032,["onClick"])):M("",!0)])]}),_:2},1024)]),_:2},1024),(Z=l.rowDetail[m.id])!=null&&Z.loading?(A(),F(Te,{key:0,loading:((ee=l.rowDetail[m.id])==null?void 0:ee.loading)||!1,"bg-color":"#fff"},null,8,["loading"])):M("",!0)])]}),_:1},8,["expanded-row-keys","columns","data-source","scroll","loading","pagination"]),e(Ze,{visible:c(C),"onUpdate:visible":t[4]||(t[4]=m=>Y(C)?C.value=m:null),onSubmitted:t[5]||(t[5]=()=>c(n)())},null,8,["visible"]),e(mt,{visible:l.detailVisible,"onUpdate:visible":t[6]||(t[6]=m=>l.detailVisible=m),"command-id":l.id,onClose:t[7]||(t[7]=()=>l.detailVisible=!1)},null,8,["visible","command-id"])]),_:1})])}}}),Vt=X(gt,[["__scopeId","data-v-2628a177"]]);export{Vt as default};
