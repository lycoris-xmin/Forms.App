import{_ as j}from"./table-header-operation.vue_vue_type_script_setup_true_lang-C7seoTxq.js";import{_ as G}from"./cny-Bw4WYv4c.js";import{_ as K,S as J,a as X,b as Y,T as Z,u as ee,c as te,d as se,e as ae}from"./table-search-filter-DgS7ifzw.js";import{m as z,d as Q,D as F,E as q,c as S,o as y,w as s,f as t,z as H,e as a,B as O,s as M,F as ne,t as x,b as D,g as U,M as le,q as oe,h as d,a8 as L,a9 as ie}from"./index-CZVtSjPQ.js";import{u as re,A as ue}from"./app.permissions-B_pV7apU.js";import{u as de,F as pe,_ as ce}from"./form-ZxLsforZ.js";import{_ as N}from"./index.vue_vue_type_script_setup_true_lang-pVOlQRHe.js";import{_ as me}from"./index-DOEbmRvB.js";import{L as fe}from"./index-Y4HE4_-c.js";import{C as W}from"./index-ClUX1lZP.js";import{D as _e,a as ye}from"./index-CmnjSmWG.js";import{S as ve}from"./index-BWb-9rJv.js";import{_ as ge}from"./index-BVBn8Dpq.js";import{T as E}from"./index-DMMLrYUn.js";import{_ as be}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./index-CQCXu6T9.js";import"./EyeOutlined-B3DWie8W.js";import"./index-Ds_LW8Zf.js";import"./LeftOutlined-Cj56myxb.js";import"./responsiveObserve-CdtC9r70.js";import"./debounce-BsWDECm-.js";import"./isSymbol-DgABtkrl.js";import"./enums-XBoEbamp.js";function Ie(u){const{pageIndex:o,pageSize:f}=u,p={pageIndex:o,pageSize:f};return typeof u.status=="number"&&(p.status=u.status),u.userId&&(p.userId=u.userId),u.pairUserId&&(p.pairUserId=u.pairUserId),z({url:"/api/plantask/settlement/list",params:{...p}})}function ke(u){return z({url:`/api/planTask/settlement/${u}`})}function xe(u){return z({url:"/api/planTask/settlement",method:"put",data:{id:u}})}const V=[{value:0,label:"未结算",color:"error"},{value:10,label:"已结算(手动)",color:"success"},{value:11,label:"已结算(自动)",color:"purple"},{value:21,label:"结算失败",color:"error"}],Te={class:"flex-1"},Pe={class:"w-full flex-y-center justify-end gap-12px"},we=Q({name:"PlanTaskSettlementListSearch",__name:"search-filter",props:F({status:{default:()=>[]},userInfo:{default:()=>{}}},{model:{required:!0},modelModifiers:{}}),emits:F(["reset","search"],["update:model"]),setup(u,{emit:o}){const{formRef:f,validate:p,resetFields:i}=de(),r=q(u,"model"),c=u,I=o;async function T(){await i(),I("reset")}async function h(){await p(),I("search")}return(_,e)=>{const k=J,m=ce,v=me,P=X,w=O,C=Y,R=K,B=pe;return y(),S(Z,null,{default:s(()=>[t(B,{ref_key:"formRef",ref:f,name:"filer",model:r.value,"label-col":{span:5,md:7}},{default:s(()=>[t(R,{gutter:[16,16],wrap:""},{default:s(()=>[t(v,{span:24,md:12,lg:6},{default:s(()=>[t(m,{label:"状态",name:"status"},{default:s(()=>[t(k,{value:r.value.status,"onUpdate:value":e[0]||(e[0]=l=>r.value.status=l),placeholder:"- 全部 -",options:c.status,"allow-clear":""},null,8,["value","options"])]),_:1})]),_:1}),c.userInfo.isTenant?c.userInfo.isTenantUser?H("",!0):(y(),S(v,{key:1,span:24,md:12,lg:6},{default:s(()=>[t(m,{label:"收款员工",name:"userId",class:"m-0"},{default:s(()=>[t(N,{value:r.value.userId,"onUpdate:value":e[2]||(e[2]=l=>r.value.userId=l),placeholder:"- 全部 -","tenant-user":!0},null,8,["value"])]),_:1})]),_:1})):(y(),S(v,{key:0,span:24,md:12,lg:6},{default:s(()=>[t(m,{label:"收款商户",name:"userId",class:"m-0"},{default:s(()=>[t(N,{value:r.value.userId,"onUpdate:value":e[1]||(e[1]=l=>r.value.userId=l),placeholder:"- 全部 -"},null,8,["value"])]),_:1})]),_:1})),c.userInfo.isTenant?c.userInfo.isTenantUser?H("",!0):(y(),S(v,{key:3,span:24,md:12,lg:6},{default:s(()=>[t(m,{label:"付款员工",name:"pairUserId",class:"m-0"},{default:s(()=>[t(N,{value:r.value.pairUserId,"onUpdate:value":e[4]||(e[4]=l=>r.value.pairUserId=l),placeholder:"- 全部 -","tenant-user":!0},null,8,["value"])]),_:1})]),_:1})):(y(),S(v,{key:2,span:24,md:12,lg:6},{default:s(()=>[t(m,{label:"付款商户",name:"pairUserId",class:"m-0"},{default:s(()=>[t(N,{value:r.value.pairUserId,"onUpdate:value":e[3]||(e[3]=l=>r.value.pairUserId=l),placeholder:"- 全部 -"},null,8,["value"])]),_:1})]),_:1})),a("div",Te,[t(m,{class:"m-0"},{default:s(()=>[a("div",Pe,[t(w,{onClick:T},{icon:s(()=>[t(P,{class:"align-sub text-icon"})]),default:s(()=>[e[5]||(e[5]=a("span",{class:"ml-8px"},"重置",-1))]),_:1}),t(w,{type:"primary",ghost:"",onClick:h},{icon:s(()=>[t(C,{class:"align-sub text-icon"})]),default:s(()=>[e[6]||(e[6]=a("span",{class:"ml-8px"},"搜索",-1))]),_:1})])]),_:1})])]),_:1})]),_:1},8,["model"])]),_:1})}}}),Ae={class:"body"},Se={class:"plan-grid"},Ue={class:"cny"},he={class:"plan-grid"},Ce={class:"cny"},Re={class:"pay-grid"},De={class:"v-center center flex"},Ne=["src"],Fe={key:1,class:"v-center center flex"},Be={class:"v-center center flex"},$e=["src"],Ee={key:1,class:"v-center center flex"},Me={class:"p-10px"},ze={class:"price"},Qe={class:"price"},Oe={class:"cny"},He=Q({name:"SettlementAuditDrawer",__name:"settlement-drawer",props:F({id:{},isAdmin:{type:Boolean}},{visible:{type:Boolean,default:!1},visibleModifiers:{}}),emits:F(["submitted"],["update:visible"]),setup(u,{emit:o}){const f=q(u,"visible"),p=M({submit:!1,loading:!0}),i=M({id:"",task:{},pairTask:{},alipayAccount:"",alipayQRCode:"",wechatPayQRCode:"",diffPayPrice:""}),r=o,c=u;ne(f,async()=>{f.value&&c.id!==i.id&&(await I(),i.id=c.id)});async function I(){p.loading=!0;try{const{data:_,error:e}=await ke(c.id);!e&&_&&_.code===0&&Object.assign(i,_.data)}finally{p.loading=!1}}function T(){f.value=!1}function h(){le.confirm({title:c.isAdmin?"警告":"提示",content:c.isAdmin?"确定要替该商家进行结算处理？":"确定已经结算了？",okText:"确定",cancelText:"取消",onOk:async()=>{var _;i.id="",p.submit=!0;try{const{data:e,error:k}=await xe(c.id);!k&&e&&e.code===0&&((_=window.$message)==null||_.success("保存成功"),T(),r("submitted"))}finally{p.submit=!1}}})}return(_,e)=>{const k=ye,m=_e,v=W,P=O,w=ve,C=ge;return y(),S(C,{open:f.value,"onUpdate:open":e[0]||(e[0]=R=>f.value=R),title:"差价结算",width:550},{footer:s(()=>[t(w,{size:16},{default:s(()=>[t(P,{onClick:T},{default:s(()=>e[12]||(e[12]=[U("取消")])),_:1}),t(P,{type:"primary",loading:p.submit,onClick:h},{default:s(()=>e[13]||(e[13]=[U("已结算")])),_:1},8,["loading"])]),_:1})]),default:s(()=>[a("div",Ae,[t(v,{title:"任务概况"},{default:s(()=>[t(m,{bordered:"",class:"expanded-row",column:1},{default:s(()=>[t(k,{span:1},{label:s(()=>e[1]||(e[1]=[a("p",{class:"label"},"我方任务",-1)])),default:s(()=>[a("div",Se,[e[2]||(e[2]=a("p",null,"商品标题：",-1)),a("p",null,x(i.pairTask.title),1),e[3]||(e[3]=a("p",null,"购买件数：",-1)),a("p",null,x(i.pairTask.count),1),e[4]||(e[4]=a("p",null,"支付金额：",-1)),a("p",Ue,x(i.pairTask.price),1)])]),_:1}),t(k,{span:1},{label:s(()=>e[5]||(e[5]=[a("p",{class:"label"},"配对任务",-1)])),default:s(()=>[a("div",he,[e[6]||(e[6]=a("p",null,"商品标题：",-1)),a("p",null,x(i.task.title),1),e[7]||(e[7]=a("p",null,"购买件数：",-1)),a("p",null,x(i.task.count),1),e[8]||(e[8]=a("p",null,"支付金额：",-1)),a("p",Ce,x(i.task.price),1)])]),_:1})]),_:1})]),_:1}),t(v,{title:"支付信息"},{default:s(()=>[a("div",Re,[a("div",De,[i.alipayQRCode?(y(),D("img",{key:0,src:i.alipayQRCode},null,8,Ne)):(y(),D("div",Fe,e[9]||(e[9]=[a("p",null,"对方暂未提供收款码",-1)])))]),a("div",Be,[i.wechatPayQRCode?(y(),D("img",{key:0,src:i.wechatPayQRCode},null,8,$e)):(y(),D("div",Ee,e[10]||(e[10]=[a("p",null,"对方暂未提供收款码",-1)])))])]),a("div",Me,[a("p",ze,"支付宝："+x(i.alipayAccount),1),a("p",Qe,[e[11]||(e[11]=U(" 待补差价： ")),a("span",Oe,x(i.diffPayPrice),1)])])]),_:1}),t(fe,{loading:p.loading,"bg-color":"#fff"},null,8,["loading"])])]),_:1},8,["open"])}}}),Le={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"},Ve=Q({name:"report_settlement",__name:"index",setup(u){const o=oe(),f=re(),{tableWrapperRef:p,scrollConfig:i}=ee(),r=M({id:"",visible:!1}),{columns:c,columnChecks:I,data:T,getData:h,getDataByPage:_,loading:e,mobilePagination:k,searchParams:m,resetSearchParams:v}=te({apiFn:l=>Ie(l),apiParams:{pageIndex:1,pageSize:10},columns:C}),{checkedRowKeys:P,rowSelection:w}=se(T,h);function C(){const l=[{key:"payPrice",dataIndex:"payPrice",title:o.userInfo.isTenant?"我方支付金额":"任务方支付金额",customRender:({record:n})=>{if(o.userInfo.isTenant){const b=n.userId===o.userInfo.id?n.payPrice:n.pairPayPrice;return Number.parseFloat(b)>0?t("span",{class:"cny"},[b]):t(E,{color:"error"},{default:()=>[U("支付失败")]})}return t("span",{class:"cny"},[n.payPrice])}}];o.userInfo.isTenant?o.userInfo.isTenantUser||l.push({key:"userName",dataIndex:"userName",title:"员工",customRender:({record:n})=>{if(n.userId===o.userInfo.id){if(n.userName)return n.userName}else if(n.pairUserName)return n.pairUserName;return"用户异常"}}):l.push({key:"userName",dataIndex:"userName",title:"任务方商户"}),l.push({key:"pairPayPrice",dataIndex:"pairPayPrice",title:o.userInfo.isTenant?"对方支付金额":"配对方支付金额",customRender:({record:n})=>{if(o.userInfo.isTenant){const b=n.userId===o.userInfo.id?n.pairPayPrice:n.payPrice;return Number.parseFloat(b)>0?t("span",{class:"cny"},[b]):t("span",{class:"cny"},[U("支付失败")])}return t("span",{class:"cny"},[n.pairPayPrice])}}),o.userInfo.isTenant||l.push({key:"pairUserName",dataIndex:"pairUserName",title:"配对方商户"});const g=[{key:"pairDiffPrice",dataIndex:"pairDiffPrice",title:"支付差价",align:"right",customRender:({record:n})=>t("span",{class:"cny"},[n.pairDiffPrice])},{key:"status",dataIndex:"status",title:"状态",align:"center",width:150,customRender:({record:n})=>{const b=V.filter($=>$.value===n.status)[0];return t(E,{color:b.color},{default:()=>[b.label]})}},{key:"createTime",dataIndex:"createTime",title:"创建时间",align:"center",width:200},{key:"settlementTime",dataIndex:"settlementTime",title:"结算时间",align:"center",width:200},{key:"operate",title:"操作",align:"center",width:100,customRender:({record:n})=>(n.userId===o.userInfo.id||!o.userInfo.isTenant)&&n.status===0?t("div",{class:"flex-center gap-4px"},[R(n)]):t(E,{ghost:!0},{default:()=>[U("无可用操作")]})}];return[...l,...g]}function R(l){return f.hasOne(ue.Report.Settlement.UPDATE)?t(ie,{placement:"top",title:"结算"},{default:()=>[t(O,{size:"small",type:"link",onClick:()=>B(l.id)},{default:()=>[t(G,null,null)]})]}):""}function B(l){r.visible=!0,r.id=l}return(l,g)=>{const n=j,b=ae,$=W;return y(),D("div",Le,[t(we,{model:d(m),"onUpdate:model":g[0]||(g[0]=A=>L(m)?m.value=A:null),status:d(V),"user-info":d(o).userInfo,onReset:d(v),onSearch:g[1]||(g[1]=A=>d(_)(1))},null,8,["model","status","user-info","onReset"]),t($,{title:"结算列表",bordered:!1,"body-style":{flex:1,overflow:"hidden"},class:"flex-col-stretch sm:flex-1-hidden card-wrapper"},{extra:s(()=>[t(n,{columns:d(I),"onUpdate:columns":g[2]||(g[2]=A=>L(I)?I.value=A:null),"disabled-delete":d(P).length===0,loading:d(e),"add-btn":!1,"delete-btn":!1},null,8,["columns","disabled-delete","loading"])]),default:s(()=>[t(b,{ref_key:"tableWrapperRef",ref:p,columns:d(c),"data-source":d(T),size:"small","row-selection":d(w),scroll:d(i),loading:d(e),"row-key":"id",pagination:d(k),class:"h-full"},null,8,["columns","data-source","row-selection","scroll","loading","pagination"]),t(He,{id:r.id,visible:r.visible,"onUpdate:visible":g[3]||(g[3]=A=>r.visible=A),"is-admin":!d(o).userInfo.isTenant,onSubmitted:d(_)},null,8,["id","visible","is-admin","onSubmitted"])]),_:1})])}}}),ft=be(Ve,[["__scopeId","data-v-bcb472e0"]]);export{ft as default};
