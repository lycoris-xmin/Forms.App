import{_ as re}from"./table-header-operation.vue_vue_type_script_setup_true_lang-C7seoTxq.js";import{_ as ie,a as ue,b as de,T as ce,u as pe,c as me,d as fe,e as _e,f as ve}from"./table-search-filter-DgS7ifzw.js";import{m as $,d as V,D as N,E as Y,s as ge,a as q,r as be,F as G,c as ee,o as M,w as n,e as g,f as a,b as O,h as s,z as he,t as Z,ac as Q,B as K,g as I,a8 as j,a9 as we}from"./index-CZVtSjPQ.js";import{u as ke,A as J}from"./app.permissions-B_pV7apU.js";import{u as te,a as ye,F as ae,_ as ne,I as oe,d as xe}from"./form-ZxLsforZ.js";import{U as Ae}from"./index-CENDnRYG.js";import{I as De}from"./InboxOutlined-DqN1pcZJ.js";import{_ as Ce}from"./index-CblUf4ME.js";import{S as Fe}from"./index-BWb-9rJv.js";import{_ as Se}from"./index-BVBn8Dpq.js";import{_ as Re}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{_ as ze}from"./index-DOEbmRvB.js";import{C as Pe}from"./index-ClUX1lZP.js";import{D as Te}from"./DeleteOutlined-CShsKEiR.js";import"./index-CQCXu6T9.js";import"./EyeOutlined-B3DWie8W.js";import"./index-Ds_LW8Zf.js";import"./LeftOutlined-Cj56myxb.js";import"./responsiveObserve-CdtC9r70.js";import"./debounce-BsWDECm-.js";import"./isSymbol-DgABtkrl.js";function Le(l){const{pageIndex:c,pageSize:m}=l,u={pageIndex:c,pageSize:m};return l.name&&(u.name=l.name),l.version&&(u.version=l.version),$({url:"/api/js/script/list",params:u})}function Me(l){const{name:c,version:m,filePath:u,size:x}=l,i={name:c,version:m,filePath:u,size:x,remark:""};return l.remark&&(i.remark=l.remark),$({url:"/api/js/script",method:"post",data:i})}function X(l){return $({url:"/api/js/script",method:"delete",params:{ids:l}})}function Ee(l,c){const m=new FormData;return Object.keys(l).forEach(u=>{m.append(u,l[u])}),$({url:"/api/js/script/chunk/upload",method:"post",data:m,headers:{"content-type":"multipart/form-data"},onUploadProgress:c})}function Ue(l){const{name:c,version:m,totalChunks:u,chunkFolder:x}=l;return $({url:"/api/js/script/chunk/merge",method:"post",data:{name:c,version:m,totalChunks:u,chunkFolder:x}})}const $e={class:"body"},Oe={key:0,class:"upload-box"},Be={class:"ant-upload-drag-icon"},Ie={key:1,class:"upload-box view v-center flex"},je={class:"space-between v-center flex"},Je={key:0,class:"d-wrap v-center center flex flex-col"},H=1024*1024*5,He=V({name:"AutoJsScriptOperateDrawer",__name:"operate-drawer",props:N({operateType:{default:"add"},rowData:{default:null}},{visible:{type:Boolean,default:!1},visibleModifiers:{}}),emits:N(["submitted"],["update:visible"]),setup(l,{emit:c}){const{formRef:m,validate:u,resetFields:x}=te(),i=Y(l,"visible"),k=ge({submit:!1}),D=l,R=c,E=q(()=>({add:"新增脚本",edit:"编辑脚本"})[D.operateType]),b=q(()=>D.operateType==="edit"),e=be(z()),{defaultRequiredRule:A}=ye(),C={name:A,version:A,reamrk:A};G(i,()=>{i.value&&(P(),x())}),G(()=>e.value.fileList,()=>{if(e.value.fileList.length){let o=e.value.fileList[0].name;o=o.replace(".zip","");const t=o.split("-");t.length===2&&(e.value.name=t[0],e.value.version=t[1])}else e.value.name="",e.value.version=""});function z(){return{name:"",version:"",filePath:"",size:"",reamrk:"",fileList:[],percent:0}}function P(){e.value=z(),b.value&&D.rowData&&Object.assign(e.value,D.rowData)}function T(){i.value=!1}async function L(){var r;if(e.value.fileList.length===0)return;const o=e.value.fileList[0].originFileObj,t=o.size,f=Math.ceil(t/H);let h=0,v="";function p(d){const{loaded:S}=d;h+=S;const y=h/t*100,_=Math.round(y);e.value.percent=_>=100?99:_}try{for(let y=0;y<f;y+=1){const _=y*H,w=Math.min(o.size,_+H),W=o.slice(_,w),le={name:e.value.name,version:e.value.version,chunk:W,chunkIndex:y,chunkFolder:v,totalSize:o.size,chunkSize:W.size,totalChunks:f},{data:B,error:se}=await Ee(le,p);if(se||!B||B.code!==0)throw new Error("上传失败");v=B.data}const{data:d,error:S}=await Ue({name:e.value.name,version:e.value.version,chunkFolder:v,totalChunks:f});!S&&d&&d.code===0&&(e.value.filePath=d.data.filePath,e.value.size=d.data.size,e.value.percent=100)}catch(d){throw(r=window.$message)==null||r.error("上传文件失败"),d}}function U(o){if(o==null)return"0";const t=1024,f=t*1024,h=f*1024;let v;return o<t?v=`${o} B`:o<f?v=`${(o/t).toFixed(2)} KB`:o<h?v=`${(o/f).toFixed(2)} MB`:v=`${(o/h).toFixed(2)} GB`,v}async function F(){var o;await u(),k.submit=!0;try{await L();const{data:t,error:f}=await Me({...e.value});!f&&t&&t.code===0&&((o=window.$message)==null||o.success("保存成功"),T(),R("submitted"))}finally{k.submit=!1}}return(o,t)=>{const f=oe,h=ne,v=xe,p=K,r=Ce,d=Ae,S=ae,y=Fe,_=Se;return M(),ee(_,{open:i.value,"onUpdate:open":t[5]||(t[5]=w=>i.value=w),title:E.value,width:550,"mask-closable":!1},{footer:n(()=>[a(y,{size:16},{default:n(()=>[a(p,{onClick:T},{default:n(()=>t[10]||(t[10]=[I("取消")])),_:1}),a(p,{type:"primary",loading:k.submit,onClick:F},{default:n(()=>t[11]||(t[11]=[I("保存")])),_:1},8,["loading"])]),_:1})]),default:n(()=>[g("div",$e,[a(S,{ref_key:"formRef",ref:m,name:"operate",layout:"vertical",model:e.value,rules:C},{default:n(()=>[a(h,{label:"脚本名称",name:"name"},{default:n(()=>[a(f,{value:e.value.name,"onUpdate:value":t[0]||(t[0]=w=>e.value.name=w),autocomplete:"off",placeholder:"脚本名称"},null,8,["value"])]),_:1}),a(h,{label:"脚本版本",name:"version"},{default:n(()=>[a(f,{value:e.value.version,"onUpdate:value":t[1]||(t[1]=w=>e.value.version=w),autocomplete:"off",placeholder:"脚本版本"},null,8,["value"])]),_:1}),a(h,{label:"脚本备注",name:"remark"},{default:n(()=>[a(v,{value:e.value.remark,"onUpdate:value":t[2]||(t[2]=w=>e.value.remark=w),"auto-size":{minRows:4},maxlength:100,"show-count":""},null,8,["value"])]),_:1}),a(h,{label:"脚本文件"},{default:n(()=>[a(d,{"file-list":e.value.fileList,"onUpdate:fileList":t[4]||(t[4]=w=>e.value.fileList=w),class:"upload","before-upload":()=>!1,name:"file",accept:".zip, application/zip","show-upload-list":!1},{default:n(()=>[e.value.fileList.length===0?(M(),O("div",Oe,[g("p",Be,[a(s(De))]),t[6]||(t[6]=g("p",{class:"ant-upload-text"},"请选择脚本文件",-1)),t[7]||(t[7]=g("p",{class:"ant-upload-hint"},"支持拖拽上传，上传期间请不要关闭窗口",-1))])):(M(),O("div",Ie,[g("p",je,[g("span",null,Z(e.value.fileList[0].name),1),g("span",null,Z(U(e.value.fileList[0].size)),1)]),g("div",{class:"d-wrap v-center center del flex",onClick:Q(()=>{},["stop"])},[a(p,{danger:"",onClick:t[3]||(t[3]=Q(()=>e.value.fileList=[],["stop"]))},{default:n(()=>t[8]||(t[8]=[I("删除")])),_:1})]),k.submit?(M(),O("div",Je,[a(r,{type:"circle",percent:e.value.percent,size:80},null,8,["percent"]),t[9]||(t[9]=g("p",null,"文件上传中，请勿关闭窗口",-1))])):he("",!0)]))]),_:1},8,["file-list"])]),_:1})]),_:1},8,["model"])])]),_:1},8,["open","title"])}}}),Ne=Re(He,[["__scopeId","data-v-97acc7ae"]]),Ve={class:"flex-1"},Ke={class:"w-full flex-y-center justify-end gap-12px"},We=V({name:"PlatformAutoScriptListSearch",__name:"search-filter",props:{model:{required:!0},modelModifiers:{}},emits:N(["reset","search"],["update:model"]),setup(l,{emit:c}){const{formRef:m,validate:u,resetFields:x}=te(),i=Y(l,"model"),k=c;async function D(){await x(),k("reset")}async function R(){await u(),k("search")}return(E,b)=>{const e=oe,A=ne,C=ze,z=ue,P=K,T=de,L=ie,U=ae;return M(),ee(ce,null,{default:n(()=>[a(U,{ref_key:"formRef",ref:m,name:"filer",model:i.value,"label-col":{span:5,md:7}},{default:n(()=>[a(L,{gutter:[16,16],wrap:""},{default:n(()=>[a(C,{span:24,md:12,lg:6},{default:n(()=>[a(A,{label:"脚本名称",name:"name",class:"m-0"},{default:n(()=>[a(e,{value:i.value.name,"onUpdate:value":b[0]||(b[0]=F=>i.value.name=F),autocomplete:"off",placeholder:"支持模糊查询"},null,8,["value"])]),_:1})]),_:1}),a(C,{span:24,md:12,lg:6},{default:n(()=>[a(A,{label:"版本号",name:"version",class:"m-0"},{default:n(()=>[a(e,{value:i.value.version,"onUpdate:value":b[1]||(b[1]=F=>i.value.version=F),autocomplete:"off",placeholder:"支持模糊查询"},null,8,["value"])]),_:1})]),_:1}),g("div",Ve,[a(A,{class:"m-0"},{default:n(()=>[g("div",Ke,[a(P,{onClick:D},{icon:n(()=>[a(z,{class:"align-sub text-icon"})]),default:n(()=>[b[2]||(b[2]=g("span",{class:"ml-8px"},"重置",-1))]),_:1}),a(P,{type:"primary",ghost:"",onClick:R},{icon:n(()=>[a(T,{class:"align-sub text-icon"})]),default:n(()=>[b[3]||(b[3]=g("span",{class:"ml-8px"},"搜索",-1))]),_:1})])]),_:1})])]),_:1})]),_:1},8,["model"])]),_:1})}}}),qe={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"},vt=V({name:"maintain_script",__name:"index",setup(l){const c=ke(),{tableWrapperRef:m,scrollConfig:u}=pe(),{columns:x,columnChecks:i,data:k,getData:D,getDataByPage:R,loading:E,mobilePagination:b,searchParams:e,resetSearchParams:A}=me({apiFn:Le,apiParams:{pageIndex:1,pageSize:10},columns:h}),{drawerVisible:C,operateType:z,editingData:P,handleAdd:T,checkedRowKeys:L,rowSelection:U,onBatchDeleted:F,onDeleted:o}=fe(k,D);async function t(){const p=L.value;if(p&&p.length){const{data:r,error:d}=await X(p);!d&&r&&r.code===0&&F()}}async function f(p){const{data:r,error:d}=await X([p]);!d&&r&&r.code===0&&o()}function h(){return[{key:"name",dataIndex:"name",title:"脚本名称",width:200,ellipsis:!0},{key:"version",dataIndex:"version",title:"版本号",width:150,align:"center"},{key:"size",dataIndex:"size",title:"文件大小",align:"center",width:150},{key:"remark",dataIndex:"remark",title:"文件备注",minWidth:150,ellipsis:!0},{key:"filePath",dataIndex:"filePath",title:"文件位置",minWidth:200,ellipsis:!0},{key:"createTime",dataIndex:"createTime",title:"上传时间",align:"center",width:200},{key:"operate",title:"操作",align:"center",width:80,customRender:({record:r})=>v(r)}]}function v(p){return c.hasOne(J.Maintain.AutoJsScript.DELETE)?a(ve,{title:"确认删除吗？",onConfirm:()=>f(p.id)},{default:()=>[a(we,{placement:"top",title:"删除"},{default:()=>[a(K,{danger:!0,size:"small",type:"link"},{default:()=>[a(Te,null,null)]})]})]}):""}return(p,r)=>{const d=re,S=_e,y=Pe;return M(),O("div",qe,[a(We,{model:s(e),"onUpdate:model":r[0]||(r[0]=_=>j(e)?e.value=_:null),onReset:s(A),onSearch:r[1]||(r[1]=_=>s(R)(1))},null,8,["model","onReset"]),a(y,{title:"脚本列表",bordered:!1,"body-style":{flex:1,overflow:"hidden"},class:"flex-col-stretch sm:flex-1-hidden card-wrapper"},{extra:n(()=>[a(d,{columns:s(i),"onUpdate:columns":r[2]||(r[2]=_=>j(i)?i.value=_:null),"disabled-delete":s(L).length===0,loading:s(E),"add-btn":s(c).hasOne(s(J).Maintain.AutoJsScript.CREATE),"delete-btn":s(c).hasOne(s(J).Maintain.AutoJsScript.DELETE),onAdd:s(T),onDelete:t},null,8,["columns","disabled-delete","loading","add-btn","delete-btn","onAdd"])]),default:n(()=>[a(S,{ref_key:"tableWrapperRef",ref:m,columns:s(x),"data-source":s(k),size:"small","row-selection":s(U),scroll:s(u),loading:s(E),"row-key":"id",pagination:s(b),class:"h-full"},null,8,["columns","data-source","row-selection","scroll","loading","pagination"]),a(Ne,{visible:s(C),"onUpdate:visible":r[3]||(r[3]=_=>j(C)?C.value=_:null),"operate-type":s(z),"row-data":s(P),onSubmitted:s(R)},null,8,["visible","operate-type","row-data","onSubmitted"])]),_:1})])}}});export{vt as default};
